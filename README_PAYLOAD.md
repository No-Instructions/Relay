# Obsidian Relay Client - Payload CMS Compatible

This version of the Obsidian Relay client is updated to work with the Payload CMS 3 control plane.

## Quick Start

1. Install the plugin in Obsidian
2. Configure settings:
   - Control Plane URL: `https://your-control-plane.example.com`
   - Relay ID: Your relay identifier
3. Click "Login" to authenticate via OIDC
4. Start collaborating!

## Changes from Previous Version

### API Endpoints

- Base API URL changed from `/api/trpc` to `/api`
- Authentication endpoints updated for Payload:
  - Login: `/api/auth/oidc/login`
  - Callback: `/api/auth/oidc/callback`
- Token generation endpoints remain the same:
  - Document tokens: `POST /api/token`
  - File tokens: `POST /api/file-token`

### Authentication

- Now uses Payload's OIDC authentication
- Supports any OIDC provider (Keycloak, Auth0, Okta, etc.)
- Session-based authentication with cookies

## Configuration

### Plugin Settings

```
Control Plane URL: https://control.example.com
Relay ID: my-relay-id
```

### Control Plane Requirements

Your control plane must be running Payload CMS 3 with:
- OIDC authentication configured
- Token generation endpoints enabled
- Relay server URL configured in Configuration global

## Token Generation

The plugin requests tokens from the control plane for:

1. **Document Access**: When opening a shared document
2. **File Access**: When uploading/downloading files

Tokens are:
- Generated by the control plane
- Signed with the relay server's private key
- Compatible with y-sweet relay server format
- Cached locally until expiry

## Troubleshooting

### Login Fails

- Check control plane URL is correct
- Verify OIDC is configured in control plane
- Check browser allows opening obsidian:// protocol

### Token Generation Fails

- Ensure you're logged in
- Check control plane has auth private key configured
- Verify relay ID matches a relay you have access to

### Connection Issues

- Check relay server is running
- Verify relay server URL in control plane configuration
- Ensure firewall allows WebSocket connections

## Development

### Building

```bash
npm install
npm run build
```

### Testing

1. Set up local control plane with Payload CMS
2. Configure OIDC provider (Keycloak recommended for testing)
3. Update plugin settings to point to local control plane
4. Test authentication and token generation

## Related Projects

- **Control Plane**: https://github.com/cortex-reply/obsidian-relay-control
- **Relay Server**: https://github.com/cortex-reply/obsidian-relay-server

## Support

For issues related to:
- **Plugin**: Open issue in this repository
- **Control Plane**: Open issue in obsidian-relay-control
- **Relay Server**: Open issue in obsidian-relay-server
